<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì‹ ê²½ì°¨ë‹¨ìˆ  ìˆ˜ì‹ ìë‹¹Â·ê±´ë‹¹ íšŸìˆ˜ (ë³´í—˜ìœ í˜• 3êµ¬ì—­)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS (ì—‘ì…€ íŒŒì„œ) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --accent: #22d3ee;
      --accent-soft: rgba(34, 211, 238, 0.1);
      --accent-border: rgba(34, 211, 238, 0.3);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        Roboto, "Noto Sans KR", sans-serif;
      background: radial-gradient(circle at top, #0b1120 0, #000 55%);
      color: var(--text);
    }
    h1, h2, h3 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.02em;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 18px;
      margin-bottom: 12px;
    }
    p {
      margin: 4px 0;
      font-size: 13px;
      color: var(--muted);
    }
    .page {
      max-width: 1320px;
      margin: 0 auto;
    }
    .header {
      margin-bottom: 12px;
    }
    .header-sub {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .chip {
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-border);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
    }

    /* ===== ê¸°ê°„ ì„ íƒ ë°” ===== */
    .period-bar {
      margin: 12px 0 18px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      font-size: 12px;
      color: var(--muted);
    }
    .period-label-main {
      font-size: 12px;
      color: var(--text);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .period-label-main::before {
      content: "ğŸ“…";
      font-size: 13px;
    }
    .period-control {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .period-caption {
      font-size: 11px;
      color: var(--muted);
    }
    .period-input-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
    }
    .period-control input[type="month"] {
      background: linear-gradient(135deg, #020617 0%, #020617 45%, #020617 100%);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 0 0 2px rgba(34, 211, 238, 0.25);
      padding: 6px 28px 6px 10px;
      color: var(--text);
      font-size: 12px;
      min-width: 130px;
      cursor: pointer;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, transform 0.1s ease;
    }
    .period-control input[type="month"]:hover,
    .period-control input[type="month"]:focus {
      border-color: var(--accent);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 1),
        0 0 0 3px rgba(34, 211, 238, 0.6);
      transform: translateY(-1px);
    }
    .period-input-icon {
      position: absolute;
      right: 8px;
      pointer-events: none;
      font-size: 11px;
      color: var(--accent);
      opacity: 0.9;
    }
    .period-separator {
      font-size: 12px;
      color: var(--muted);
      padding-top: 16px;
    }
    .period-bar button {
      border-radius: 999px;
      border: 1px solid var(--accent-border);
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      padding: 5px 12px;
      cursor: pointer;
      margin-left: 4px;
    }
    .period-bar button:hover {
      border-color: var(--accent);
    }
    .period-help {
      font-size: 11px;
      color: var(--muted);
      flex-basis: 100%;
    }
    @media (max-width: 768px) {
      .period-control input[type="month"] {
        min-width: 0;
        width: 120px;
      }
    }
    /* ===== /ê¸°ê°„ ì„ íƒ ë°” ===== */

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 1.1fr 1.1fr;
      gap: 16px;
      margin-bottom: 20px;
    }
    @media (max-width: 1024px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      border-radius: 16px;
      padding: 14px 14px 10px;
      background: radial-gradient(circle at top left, #0b1120 0, #020617 50%);
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 18px 35px rgba(15, 23, 42, 0.8);
    }
    .card-title {
      font-size: 15px;
      margin-bottom: 4px;
    }
    .card-tag {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .file-zone {
      border-radius: 12px;
      border: 1px dashed rgba(148, 163, 184, 0.5);
      padding: 10px;
      font-size: 12px;
      background: rgba(15, 23, 42, 0.9);
    }
    .file-zone input[type="file"] {
      margin-top: 8px;
      width: 100%;
      font-size: 11px;
    }
    .file-hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
    }
    .file-list {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
      max-height: 80px;
      overflow-y: auto;
    }
    .file-item {
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .summary-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 11px;
    }
    .summary-pill {
      padding: 3px 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--muted);
    }

    .results-section { margin-top: 18px; }
    .results-row {
      display: grid;
      grid-template-columns: minmax(0, 1.3fr) minmax(0, 1.4fr);
      gap: 16px;
    }
    @media (max-width: 1024px) {
      .results-row { grid-template-columns: 1fr; }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 11.5px;
    }
    th, td {
      border: 1px solid rgba(51, 65, 85, 0.9);
      padding: 5px 6px;
      text-align: right;
      white-space: nowrap;
    }
    th {
      background: rgba(15, 23, 42, 0.9);
      color: var(--muted);
      font-weight: 600;
    }
    th:first-child, td:first-child {
      text-align: left;
    }
    tr:nth-child(even) td {
      background: rgba(15, 23, 42, 0.8);
    }
    .cell-strong {
      color: var(--accent);
      font-weight: 600;
    }
    .cell-danger { color: var(--danger); }

    .note {
      font-size: 11px;
      color: var(--muted);
      margin-top: 6px;
      line-height: 1.4;
    }
    .error {
      color: var(--danger);
      font-size: 11px;
      margin-top: 4px;
    }
    .tiny { font-size: 10px; }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <h1>ì‹ ê²½ì°¨ë‹¨ìˆ  ìˆ˜ì‹ ìë‹¹Â·ê±´ë‹¹ íšŸìˆ˜ (ë³´í—˜ìœ í˜• 3êµ¬ì—­)</h1>
    <div class="header-sub">
      <span>LAì½”ë“œÂ·ë³´í—˜ìœ í˜•ë³„ë¡œ ë¯¸ë¦¬ í•„í„°ë§ëœ ì—‘ì…€ì„ êµ¬ì—­ë³„(ê±´ê°•/ì˜ë£Œê¸‰ì—¬/ìë³´)ë¡œ ì˜¬ë ¤ì„œ, ìˆ˜ì‹ ìë‹¹Â·ê±´ë‹¹ íšŸìˆ˜ ë° 65ì„¸ ê¸°ì¤€ í†µê³„ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</span>
      <span class="chip">ìˆ˜ì‹ ìë‹¹ = í™˜ì 1ëª…ë‹¹ ê¸°ê°„ ì „ì²´ íˆ¬ì—¬ëŸ‰(í‰ê· )</span>
      <span class="chip">ê±´ë‹¹ = ë™ì¼ í™˜ìÂ·ë™ì¼ ë‚ ì§œ íˆ¬ì—¬ëŸ‰ í•©ì‚° â†’ ë°©ë¬¸ 1ê±´ë‹¹ í‰ê·  íˆ¬ì—¬ëŸ‰</span>
    </div>
  </header>

  <!-- ê¸°ê°„ ì„ íƒ ë°” -->
  <div class="period-bar">
    <div class="period-label-main">ê¸°ê°„ ì„ íƒ (ë‚´ì›ì¼ ê¸°ì¤€)</div>

    <div class="period-control">
      <div class="period-caption">ì‹œì‘ ì›” ì„ íƒ</div>
      <div class="period-input-wrap">
        <input type="month" id="period-from" />
        <span class="period-input-icon">â–¼</span>
      </div>
    </div>

    <div class="period-separator">~</div>

    <div class="period-control">
      <div class="period-caption">ì¢…ë£Œ ì›” ì„ íƒ</div>
      <div class="period-input-wrap">
        <input type="month" id="period-to" />
        <span class="period-input-icon">â–¼</span>
      </div>
    </div>

    <button id="period-reset">ì „ì²´ ê¸°ê°„</button>

    <div class="period-help">
      Â· ì‹œì‘/ì¢…ë£Œ ì›” ë°•ìŠ¤ë¥¼ í´ë¦­í•˜ë©´ ì›í•˜ëŠ” ì›”ë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ì˜ˆ: 2025-01)
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ì¹´ë“œ: ê±´ê°•ë³´í—˜ / ì˜ë£Œê¸‰ì—¬ / ìë³´ -->
  <section class="grid">
    <!-- ê±´ê°•ë³´í—˜ -->
    <div class="card">
      <div class="card-title">ê±´ê°•ë³´í—˜</div>
      <div class="card-tag">ì˜ì‚¬ë‘ ì‚¬ìš©ì í†µê³„ì—ì„œ LAì½”ë“œ + ê±´ê°•ë³´í—˜ë§Œ í•„í„°ë§í•œ ì—‘ì…€ (1ê°œ ì´ìƒ ì—…ë¡œë“œ ê°€ëŠ¥)</div>
      <div class="file-zone">
        <div>â‘  ê±´ê°•ë³´í—˜ ì—‘ì…€ íŒŒì¼ (*.xls, *.xlsx)</div>
        <input id="file-nhis" type="file" accept=".xls,.xlsx" multiple />
        <div class="file-hint">
          Â· ì—¬ëŸ¬ íŒŒì¼(1~2ì›”, ë¶„ë¦¬íŒŒì¼ ë“±) ë™ì‹œì— ì˜¬ë ¤ë„ ë©ë‹ˆë‹¤.<br/>
          Â· ì´ êµ¬ì—­ì„ ë¹„ì›Œë‘ë©´ ê±´ê°•ë³´í—˜ í†µê³„ëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        <div id="file-list-nhis" class="file-list"></div>
      </div>
      <div class="summary-row">
        <div id="summary-nhis" class="summary-pill">ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>

    <!-- ì˜ë£Œê¸‰ì—¬1Â·2ì¢… -->
    <div class="card">
      <div class="card-title">ì˜ë£Œê¸‰ì—¬ 1Â·2ì¢…</div>
      <div class="card-tag">ì˜ì‚¬ë‘ ì‚¬ìš©ì í†µê³„ì—ì„œ LAì½”ë“œ + ì˜ë£Œê¸‰ì—¬(ë³´í˜¸)ë§Œ í•„í„°ë§í•œ ì—‘ì…€</div>
      <div class="file-zone">
        <div>â‘¡ ì˜ë£Œê¸‰ì—¬(ë³´í˜¸1Â·2ì¢…) ì—‘ì…€ íŒŒì¼ (*.xls, *.xlsx)</div>
        <input id="file-medicaid" type="file" accept=".xls,.xlsx" multiple />
        <div class="file-hint">
          Â· ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥<br/>
          Â· ì´ êµ¬ì—­ì„ ë¹„ìš°ë©´ ì˜ë£Œê¸‰ì—¬ í†µê³„ëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        <div id="file-list-medicaid" class="file-list"></div>
      </div>
      <div class="summary-row">
        <div id="summary-medicaid" class="summary-pill">ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>

    <!-- ìë³´ -->
    <div class="card">
      <div class="card-title">ìë™ì°¨ë³´í—˜(ìë³´)</div>
      <div class="card-tag">ì˜ì‚¬ë‘ ì‚¬ìš©ì í†µê³„ì—ì„œ LAì½”ë“œ + ìë™ì°¨ë³´í—˜ë§Œ í•„í„°ë§í•œ ì—‘ì…€</div>
      <div class="file-zone">
        <div>â‘¢ ìë³´ ì—‘ì…€ íŒŒì¼ (*.xls, *.xlsx)</div>
        <input id="file-auto" type="file" accept=".xls,.xlsx" multiple />
        <div class="file-hint">
          Â· ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥<br/>
          Â· ì´ êµ¬ì—­ì„ ë¹„ìš°ë©´ ìë³´ í†µê³„ëŠ” ê³„ì‚°í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </div>
        <div id="file-list-auto" class="file-list"></div>
      </div>
      <div class="summary-row">
        <div id="summary-auto" class="summary-pill">ëŒ€ê¸° ì¤‘</div>
      </div>
    </div>
  </section>

  <!-- ê²°ê³¼ -->
  <section class="results-section">
    <div class="results-row">
      <!-- ì „ì²´ ìš”ì•½ -->
      <div class="card">
        <h2>â‘  ì‹ ê²½ì°¨ë‹¨ìˆ  ìš”ì•½ (ë³´í—˜ìœ í˜•ë³„)</h2>
        <div id="table-overall-wrapper"></div>
      </div>

      <!-- 65ì„¸ ê¸°ì¤€ -->
      <div class="card">
        <h2>â‘¡ 65ì„¸ ì´ìƒ / 65ì„¸ ë¯¸ë§Œ ë¹„ìœ¨ ë° ê±´ë‹¹ íšŸìˆ˜</h2>
        <div id="table-age-wrapper"></div>
      </div>
    </div>
    <div class="note">
      â€» ì—‘ì…€ í—¤ë” ì˜ˆì‹œ: <strong>ì°¨íŠ¸ë²ˆí˜¸, ìˆ˜ì§„ìëª…, ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸, ë‚´ì›ì¼, íˆ¬ì—¬ëŸ‰, íˆ¬ì—¬ì¼ìˆ˜, ì´íˆ¬ì—¬ëŸ‰</strong><br/>
      â€» ì—´ ì´ë¦„ì´ ë‹¤ë¥¸ ê²½ìš° JSì—ì„œ ì»¬ëŸ¼ íƒìƒ‰ ë¡œì§ì„ ì•½ê°„ ìˆ˜ì •í•´ ì‚¬ìš©í•˜ì…”ë„ ë©ë‹ˆë‹¤.
    </div>
  </section>
</div>

<script>
  // ---------- ê³µí†µ ìƒíƒœ ----------
  const state = {
    nhis: [],
    medicaid: [],
    auto: [],
    period: { from: null, to: null },   // 'YYYY-MM'
    autoMinMonth: null,
    autoMaxMonth: null,
  };

  // ---------- ìœ í‹¸ ----------
  function formatNumber(x, digits = 0) {
    if (x === null || x === undefined || isNaN(x)) return "-";
    const n = typeof x === "number" ? x : Number(x);
    return n.toLocaleString("ko-KR", {
      minimumFractionDigits: digits,
      maximumFractionDigits: digits,
    });
  }

  function excelSerialDateToJSDate(serial) {
    const excelEpoch = new Date(Date.UTC(1899, 11, 30));
    const ms = serial * 24 * 60 * 60 * 1000;
    return new Date(excelEpoch.getTime() + ms);
  }

  function parseDateFlexible(value) {
    if (!value && value !== 0) return null;
    if (value instanceof Date) return value;

    if (typeof value === "number") {
      return excelSerialDateToJSDate(value);
    }

    const str = String(value).trim();
    if (!str) return null;

    let m = str.match(/^(\d{4})[-/.](\d{1,2})[-/.](\d{1,2})$/);
    if (m) {
      const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
      return new Date(y, mo, d);
    }

    m = str.match(/^(\d{4})(\d{2})(\d{2})$/);
    if (m) {
      const y = Number(m[1]), mo = Number(m[2]) - 1, d = Number(m[3]);
      return new Date(y, mo, d);
    }

    const parsed = new Date(str);
    if (!isNaN(parsed.getTime())) return parsed;

    return null;
  }

  function parseBirthFromRRN(raw) {
    if (!raw && !raw !== 0) return null;
    const s = String(raw).replace(/[^0-9]/g, "");
    if (s.length < 6) return null;

    const yy = Number(s.slice(0, 2));
    const mm = Number(s.slice(2, 4)) - 1;
    const dd = Number(s.slice(4, 6));

    let yearBase = null;
    if (s.length >= 7) {
      const flag = s[6];
      if (["1", "2", "5", "6"].includes(flag)) yearBase = 1900;
      else if (["3", "4", "7", "8"].includes(flag)) yearBase = 2000;
    }
    if (!yearBase) {
      const tmpYear = 2000 + yy;
      yearBase = tmpYear > new Date().getFullYear() ? 1900 : 2000;
    }
    const fullYear = yearBase + yy;
    return new Date(fullYear, mm, dd);
  }

  function calcAge(birth, refDate) {
    if (!birth || !refDate) return null;
    let age = refDate.getFullYear() - birth.getFullYear();
    const m = refDate.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && refDate.getDate() < birth.getDate())) {
      age--;
    }
    return age;
  }

  function normalizeHeaderName(name) {
    if (!name && name !== 0) return "";
    return String(name).replace(/\s+/g, "").toLowerCase();
  }

  function findColumnKey(row, candidates) {
    if (!row) return null;
    const keys = Object.keys(row);
    for (const key of keys) {
      const norm = normalizeHeaderName(key);
      for (const cand of candidates) {
        if (norm.includes(cand)) return key;
      }
    }
    return null;
  }

  function monthKeyFromDate(d) {
    if (!d) return null;
    return d.getFullYear() * 100 + (d.getMonth() + 1);
  }

  function monthKeyFromStr(s) {
    if (!s) return null;
    const [y, m] = s.split("-");
    if (!y || !m) return null;
    return Number(y) * 100 + Number(m);
  }

  function dateToMonthValue(d) {
    if (!d) return "";
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`;
  }

  function applyPeriodFilter(rows) {
    const fromKey = monthKeyFromStr(state.period.from);
    const toKey = monthKeyFromStr(state.period.to);
    if (!fromKey && !toKey) return rows;
    return rows.filter(r => {
      const mk = monthKeyFromDate(r.date);
      if (fromKey && mk < fromKey) return false;
      if (toKey && mk > toKey) return false;
      return true;
    });
  }

  // ---------- ì—‘ì…€ íŒŒì„œ ----------
  function parseExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {
            type: "array",
            cellDates: true,
          });
          const firstSheet = workbook.SheetNames[0];
          const sheet = workbook.Sheets[firstSheet];

          const rows = XLSX.utils.sheet_to_json(sheet, {
            header: 1,
            defval: null,
          });

          if (!rows || rows.length === 0) {
            resolve([]);
            return;
          }

          let headerIdx = 0;
          for (let i = 0; i < rows.length; i++) {
            const rowArr = rows[i].map(v => (v === null ? "" : String(v)));
            const hasChart = rowArr.some(v => v.includes("ì°¨íŠ¸ë²ˆí˜¸"));
            const hasVisitDate = rowArr.some(v =>
              v.includes("ë‚´ì›ì¼") || v.includes("ì¼ì") || v.includes("ì§„ë£Œì¼")
            );
            if (hasChart && hasVisitDate) {
              headerIdx = i;
              break;
            }
          }

          const headerRow = rows[headerIdx];
          const dataRows = rows.slice(headerIdx + 1);

          const json = [];
          for (const r of dataRows) {
            const obj = {};
            for (let c = 0; c < headerRow.length; c++) {
              const key = headerRow[c] ? String(headerRow[c]) : `__col${c}`;
              obj[key] = (r[c] !== undefined ? r[c] : null);
            }
            json.push(obj);
          }
          resolve(json);
        } catch (err) {
          reject(err);
        }
      };
      reader.onerror = err => reject(err);
      reader.readAsArrayBuffer(file);
    });
  }

  // ---------- í†µê³„ ê³„ì‚° ----------
  function extractStandardRows(rawRows) {
    if (!rawRows || rawRows.length === 0) {
      return { rows: [], lastDate: null, warning: null };
    }

    const sample = rawRows[0];

    const patientKey = findColumnKey(sample, ["ì°¨íŠ¸ë²ˆí˜¸", "í™˜ìë²ˆí˜¸", "ì°¨íŠ¸", "í™˜ì"]);
    const dateKey = findColumnKey(sample, ["ë‚´ì›ì¼", "ì¼ì", "ì§„ë£Œì¼", "ë‚ ì§œ", "visit"]);
    const idKey = findColumnKey(sample, ["ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸", "ìƒë…„ì›”ì¼", "ìƒë…„ì›”", "ìƒë…„", "rrn", "birth"]);
    const totalDoseKey = findColumnKey(sample, ["ì´íˆ¬ì—¬ëŸ‰", "ì´íˆ¬ì—¬", "ì´ì‚¬ìš©ëŸ‰", "ì´ëŸ‰"]);
    const onceDoseKey = findColumnKey(sample, ["1íšŒíˆ¬ì—¬ëŸ‰", "1íšŒ", "íšŒíˆ¬ì—¬ëŸ‰", "íˆ¬ì—¬ëŸ‰"]);
    const daysKey = findColumnKey(sample, ["íˆ¬ì—¬ì¼ìˆ˜", "ì¼ìˆ˜", "days"]);

    let warn = null;
    if (!patientKey || !dateKey) {
      warn = "í•„ìˆ˜ ì»¬ëŸ¼(ì°¨íŠ¸ë²ˆí˜¸/í™˜ìë²ˆí˜¸, ë‚´ì›ì¼/ì¼ì)ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. í—¤ë”ëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
    }
    if (!totalDoseKey && !(onceDoseKey && daysKey)) {
      warn = (warn ?? "") + " ì´íˆ¬ì—¬ëŸ‰ ë˜ëŠ” (íˆ¬ì—¬ëŸ‰+íˆ¬ì—¬ì¼ìˆ˜) ì»¬ëŸ¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    }

    const rows = [];
    let lastDate = null;

    for (const raw of rawRows) {
      const patientId = patientKey ? String(raw[patientKey]).trim() : null;
      const dateVal = dateKey ? raw[dateKey] : null;
      const jsDate = parseDateFlexible(dateVal);
      const idVal = idKey ? raw[idKey] : null;
      const birthDate = idVal ? parseBirthFromRRN(idVal) : null;

      let dose = null;
      if (totalDoseKey && raw[totalDoseKey] !== null && raw[totalDoseKey] !== undefined && raw[totalDoseKey] !== "") {
        const v = Number(String(raw[totalDoseKey]).replace(/,/g, ""));
        dose = isNaN(v) ? null : v;
      } else if (onceDoseKey && daysKey) {
        const once = Number(String(raw[onceDoseKey]).replace(/,/g, ""));
        const days = Number(String(raw[daysKey]).replace(/,/g, ""));
        if (!isNaN(once) && !isNaN(days)) {
          dose = once * days;
        }
      }

      if (!patientId || !jsDate || dose === null || isNaN(dose)) continue;

      rows.push({
        patientId,
        date: jsDate,
        birth: birthDate,
        dose,
      });

      if (!lastDate || jsDate > lastDate) {
        lastDate = jsDate;
      }
    }

    return { rows, lastDate, warning: warn };
  }

  function computeStats(rows) {
    if (!rows || rows.length === 0) {
      return {
        totalPatients: 0,
        totalVisits: 0,
        totalDose: 0,
        avgDosePerVisit: 0,
        avgDosePerPatient: 0,
        visitsPerPatient: 0,
      };
    }

    const visitMap = new Map();   // key: patientId|yyyymmdd
    const patientMap = new Map(); // key: patientId

    for (const r of rows) {
      const y = r.date.getFullYear();
      const m = String(r.date.getMonth() + 1).padStart(2, "0");
      const d = String(r.date.getDate()).padStart(2, "0");
      const visitKey = `${r.patientId}|${y}${m}${d}`;

      if (!visitMap.has(visitKey)) {
        visitMap.set(visitKey, { patientId: r.patientId, totalDose: 0 });
      }
      const v = visitMap.get(visitKey);
      v.totalDose += r.dose;

      if (!patientMap.has(r.patientId)) {
        patientMap.set(r.patientId, { totalDose: 0 });
      }
      const p = patientMap.get(r.patientId);
      p.totalDose += r.dose;
    }

    const visits = Array.from(visitMap.values());
    const patients = Array.from(patientMap.values());

    const totalDoseVisits = visits.reduce((sum, v) => sum + v.totalDose, 0);
    const totalDosePatients = patients.reduce((sum, p) => sum + p.totalDose, 0);

    const totalVisits = visits.length;
    const totalPatients = patients.length;

    const avgDosePerVisit = totalVisits > 0 ? totalDoseVisits / totalVisits : 0;
    const avgDosePerPatient = totalPatients > 0 ? totalDosePatients / totalPatients : 0;
    const visitsPerPatient = totalPatients > 0 ? totalVisits / totalPatients : 0;

    return {
      totalPatients,
      totalVisits,
      totalDose: totalDosePatients,
      avgDosePerVisit,
      avgDosePerPatient,
      visitsPerPatient,
    };
  }

  function filterByAgeGroup(rows, refDate, ageGroup) {
    if (!ageGroup || !refDate) return rows;
    return rows.filter(r => {
      if (!r.birth) return false;
      const age = calcAge(r.birth, refDate);
      if (age === null) return false;
      if (ageGroup === "lt65") return age < 65;
      if (ageGroup === "gte65") return age >= 65;
      return true;
    });
  }

  // ---------- UI ë Œë” ----------
  function renderFileList(elementId, files) {
    const el = document.getElementById(elementId);
    if (!el) return;
    if (!files || files.length === 0) {
      el.innerHTML = "";
      return;
    }
    const items = Array.from(files)
      .map(f => `<div class="file-item">Â· ${f.name}</div>`)
      .join("");
    el.innerHTML = items;
  }

  function renderSummaryPill(elementId, info) {
    const el = document.getElementById(elementId);
    if (!el) return;
    if (!info || !info.rows || info.rows.length === 0) {
      el.textContent = "ë°ì´í„° ì—†ìŒ";
      return;
    }
    const { rows, lastDate, warning } = info;
    const dateStr = lastDate
      ? `${lastDate.getFullYear()}-${String(lastDate.getMonth() + 1).padStart(2, "0")}-${String(lastDate.getDate()).padStart(2, "0")}`
      : "-";
    const uniquePatients = new Set(rows.map(r => r.patientId)).size;
    el.innerHTML = `í™˜ì ${formatNumber(uniquePatients)}ëª… Â· ê¸°ë¡ ${formatNumber(rows.length)}í–‰ Â· ë§ˆì§€ë§‰ ë‚´ì›ì¼ ${dateStr}` +
      (warning ? `<div class="error">${warning}</div>` : "");
  }

  function buildOverallTitle(fromStr, toStr) {
    if (!fromStr && !toStr) return "ì „ì²´ê¸°ê°„ ì‹ ê²½ì°¨ë‹¨ìˆ ";
    if (fromStr && toStr && fromStr === toStr) return `${fromStr} ì‹ ê²½ì°¨ë‹¨ìˆ `;
    const a = fromStr || "ì „ì²´ ì‹œì‘";
    const b = toStr || "ì „ì²´ ì¢…ë£Œ";
    return `${a} ~ ${b} ì‹ ê²½ì°¨ë‹¨ìˆ `;
  }

  function renderTables() {
    const overallWrapper = document.getElementById("table-overall-wrapper");
    const ageWrapper = document.getElementById("table-age-wrapper");

    const groups = [
      { key: "nhis", label: "êµ­ë¯¼ê±´ê°•ë³´í—˜" },
      { key: "medicaid", label: "ë³´í˜¸(ì˜ë£Œê¸‰ì—¬)" },
      { key: "auto", label: "ìë³´" },
    ];

    const rowsByGroup = {};
    let allRows = [];
    let periodLastDate = null;

    for (const g of groups) {
      const infoKey = "__info_" + g.key;
      const info = state[infoKey];
      const baseRows = info && info.rows ? info.rows : [];
      const filtered = applyPeriodFilter(baseRows);
      rowsByGroup[g.key] = filtered;
      allRows = allRows.concat(filtered);

      for (const r of filtered) {
        if (!periodLastDate || r.date > periodLastDate) periodLastDate = r.date;
      }
    }

    const periodTitle = buildOverallTitle(state.period.from, state.period.to);

    // â‘  ì „ì²´ ìš”ì•½
    if (!allRows || allRows.length === 0) {
      overallWrapper.innerHTML = `
        <div class="note">ì„ íƒëœ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„ì„ ë‹¤ì‹œ ì„ íƒí•˜ê±°ë‚˜ ì—‘ì…€ì„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</div>
      `;
    } else {
      const rowsHtml = [];

      const statsByGroup = {};
      for (const g of groups) {
        const stats = computeStats(rowsByGroup[g.key]);
        statsByGroup[g.key] = stats;
        rowsHtml.push(`
          <tr>
            <td>${g.label}</td>
            <td>${formatNumber(stats.totalVisits)}</td>
            <td>${formatNumber(stats.totalDose, 2)}</td>
            <td class="cell-strong">${formatNumber(stats.avgDosePerVisit, 2)}</td>
            <td>${formatNumber(stats.totalPatients)}</td>
            <td class="cell-strong">${formatNumber(stats.avgDosePerPatient, 2)}</td>
            <td class="cell-strong">${formatNumber(stats.visitsPerPatient, 2)}</td>
          </tr>
        `);
      }

      const totalStats = computeStats(allRows);
      const totalRow = `
        <tr>
          <td><strong>ì´í•©ê³„</strong></td>
          <td class="cell-strong">${formatNumber(totalStats.totalVisits)}</td>
          <td class="cell-strong">${formatNumber(totalStats.totalDose, 2)}</td>
          <td class="cell-strong">${formatNumber(totalStats.avgDosePerVisit, 2)}</td>
          <td class="cell-strong">${formatNumber(totalStats.totalPatients)}</td>
          <td class="cell-strong">${formatNumber(totalStats.avgDosePerPatient, 2)}</td>
          <td class="cell-strong">${formatNumber(totalStats.visitsPerPatient, 2)}</td>
        </tr>
      `;

      const healthPlusMedicaidRows = rowsByGroup["nhis"].concat(rowsByGroup["medicaid"]);
      const hpStats = computeStats(healthPlusMedicaidRows);
      const hpRow = `
        <tr>
          <td>ê±´ë³´+ë³´í˜¸</td>
          <td>${formatNumber(hpStats.totalVisits)}</td>
          <td>${formatNumber(hpStats.totalDose, 2)}</td>
          <td class="cell-strong">${formatNumber(hpStats.avgDosePerVisit, 2)}</td>
          <td>${formatNumber(hpStats.totalPatients)}</td>
          <td class="cell-strong">${formatNumber(hpStats.avgDosePerPatient, 2)}</td>
          <td class="cell-strong">${formatNumber(hpStats.visitsPerPatient, 2)}</td>
        </tr>
      `;

      overallWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>${periodTitle}</th>
              <th>ì£¼ì‚¬ í™˜ììˆ˜<br/><span class="tiny">(ë°©ë¬¸ìˆ˜)</span></th>
              <th>ì£¼ì‚¬ ì´íˆ¬</th>
              <th>ê±´ë‹¹ íšŸìˆ˜</th>
              <th>í™˜ììˆ˜</th>
              <th>ìˆ˜ì‹ ìë‹¹ íšŸìˆ˜</th>
              <th>í‰ê· ì£¼ì‚¬<br/><span class="tiny">(ë°©ë¬¸/í™˜ì)</span></th>
            </tr>
          </thead>
          <tbody>
            ${totalRow}
            ${rowsHtml.join("")}
            ${hpRow}
          </tbody>
        </table>
      `;
    }

    // â‘¡ 65ì„¸ ì´ìƒ / ë¯¸ë§Œ ë¹„ìœ¨ ë° ê±´ë‹¹
    if (!allRows || allRows.length === 0 || !periodLastDate) {
      ageWrapper.innerHTML = `
        <div class="note">ì„ íƒëœ ê¸°ê°„ì˜ ë°ì´í„° ë˜ëŠ” ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸/ìƒë…„ì›”ì¼ì´ ì—†ì–´ ì—°ë ¹ í†µê³„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
      `;
    } else {
      const ageRows = [];

      function buildAgeRow(label, rowsAll) {
        const statsAll = computeStats(rowsAll);
        if (statsAll.totalPatients === 0) return "";

        const rows65p = filterByAgeGroup(rowsAll, periodLastDate, "gte65");
        const rows65m = filterByAgeGroup(rowsAll, periodLastDate, "lt65");
        const stats65p = computeStats(rows65p);
        const stats65m = computeStats(rows65m);

        const share65p = statsAll.totalPatients > 0
          ? (stats65p.totalPatients / statsAll.totalPatients) * 100
          : 0;
        const share65m = statsAll.totalPatients > 0
          ? (stats65m.totalPatients / statsAll.totalPatients) * 100
          : 0;

        return `
          <tr>
            <td>${label}</td>
            <td>${formatNumber(share65p, 2)}%</td>
            <td>${formatNumber(share65m, 2)}%</td>
            <td class="cell-strong">${formatNumber(stats65p.avgDosePerVisit, 2)}</td>
            <td class="cell-strong">${formatNumber(stats65m.avgDosePerVisit, 2)}</td>
          </tr>
        `;
      }

      const groupsArr = [
        { key: "nhis", label: "êµ­ë¯¼ê±´ê°•ë³´í—˜" },
        { key: "medicaid", label: "ë³´í˜¸(ì˜ë£Œê¸‰ì—¬)" },
        { key: "auto", label: "ìë³´" },
      ];

      for (const g of groupsArr) {
        ageRows.push(buildAgeRow(g.label, rowsByGroup[g.key]));
      }

      const healthPlusMedicaidRows = rowsByGroup["nhis"].concat(rowsByGroup["medicaid"]);
      ageRows.push(buildAgeRow("ê±´ë³´+ë³´í˜¸", healthPlusMedicaidRows));

      ageWrapper.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>ì‹ ê²½ì°¨ë‹¨ìˆ  / ìœ í˜•</th>
              <th>65ì„¸ì´ìƒ ë¹„ìœ¨</th>
              <th>65ì„¸ë¯¸ë§Œ ë¹„ìœ¨</th>
              <th>65ì„¸ì´ìƒ ê±´ë‹¹ íšŸìˆ˜</th>
              <th>65ì„¸ë¯¸ë§Œ ê±´ë‹¹ íšŸìˆ˜</th>
            </tr>
          </thead>
          <tbody>
            ${ageRows.join("")}
          </tbody>
        </table>
      `;
    }
  }

  // ---------- ê¸°ê°„ ê´€ë ¨ ----------
  function updateAutoPeriodFromData() {
    let minDate = null;
    let maxDate = null;
    ["__info_nhis", "__info_medicaid", "__info_auto"].forEach(key => {
      const info = state[key];
      if (!info || !info.rows) return;
      for (const r of info.rows) {
        if (!minDate || r.date < minDate) minDate = r.date;
        if (!maxDate || r.date > maxDate) maxDate = r.date;
      }
    });

    state.autoMinMonth = minDate ? dateToMonthValue(minDate) : null;
    state.autoMaxMonth = maxDate ? dateToMonthValue(maxDate) : null;

    const fromInput = document.getElementById("period-from");
    const toInput = document.getElementById("period-to");

    if (!state.period.from && !state.period.to) {
      state.period.from = state.autoMinMonth;
      state.period.to = state.autoMaxMonth;
      if (state.autoMinMonth) fromInput.value = state.autoMinMonth;
      if (state.autoMaxMonth) toInput.value = state.autoMaxMonth;
    }
  }

  function handlePeriodChange() {
    const fromVal = document.getElementById("period-from").value || null;
    const toVal = document.getElementById("period-to").value || null;

    if (fromVal && toVal && fromVal > toVal) {
      state.period.from = toVal;
      state.period.to = fromVal;
      document.getElementById("period-from").value = toVal;
      document.getElementById("period-to").value = fromVal;
    } else {
      state.period.from = fromVal;
      state.period.to = toVal;
    }
    renderTables();
  }

  function handlePeriodReset() {
    state.period.from = state.autoMinMonth;
    state.period.to = state.autoMaxMonth;
    const fromInput = document.getElementById("period-from");
    const toInput = document.getElementById("period-to");
    if (state.autoMinMonth) fromInput.value = state.autoMinMonth;
    if (state.autoMaxMonth) toInput.value = state.autoMaxMonth;
    renderTables();
  }

  // ---------- íŒŒì¼ ì—…ë¡œë“œ í•¸ë“¤ëŸ¬ ----------
  async function handleFileInput(event, groupKey) {
    const files = event.target.files;
    renderFileList("file-list-" + groupKey, files);

    if (!files || files.length === 0) {
      state[groupKey] = [];
      state["__info_" + groupKey] = { rows: [], lastDate: null, warning: null };
      renderSummaryPill("summary-" + groupKey, { rows: [], lastDate: null, warning: null });
      updateAutoPeriodFromData();
      renderTables();
      return;
    }

    const allRows = [];
    let warning = null;

    for (const file of files) {
      try {
        const rows = await parseExcelFile(file);
        allRows.push(...rows);
      } catch (err) {
        console.error("ì—‘ì…€ íŒŒì‹± ì˜¤ë¥˜:", err);
        warning = (warning ?? "") + ` [${file.name}] íŒŒì‹± ì˜¤ë¥˜`;
      }
    }

    const info = extractStandardRows(allRows);
    if (warning) {
      info.warning = (info.warning ? info.warning + " / " : "") + warning;
    }

    state[groupKey] = allRows;
    state["__info_" + groupKey] = info;

    renderSummaryPill("summary-" + groupKey, info);
    updateAutoPeriodFromData();
    renderTables();
  }

  // ---------- ì´ˆê¸° ë°”ì¸ë”© ----------
  document.getElementById("file-nhis").addEventListener("change", e => handleFileInput(e, "nhis"));
  document.getElementById("file-medicaid").addEventListener("change", e => handleFileInput(e, "medicaid"));
  document.getElementById("file-auto").addEventListener("change", e => handleFileInput(e, "auto"));

  document.getElementById("period-from").addEventListener("change", handlePeriodChange);
  document.getElementById("period-to").addEventListener("change", handlePeriodChange);
  document.getElementById("period-reset").addEventListener("click", handlePeriodReset);

  // ì²« ë Œë”
  renderTables();
</script>
</body>
</html>